<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>will you be my valentine?</title>

  <style>
    :root{
      --pink:#ff4d8d;
      --pink2:#ff8fb8;
      --dark:#b21f55;
      --paperText:#3b1f2b;
      --border: rgba(255,77,141,0.25);
      --shadow: rgba(255,77,141,0.25);

      --youShadeName: "blush pink";
      --cpuShadeName: "deep rose";
      --youPiece:#ff77b7;
      --cpuPiece:#d81b60;

      --boardLight: rgba(255,255,255,0.78);
      --boardDark: rgba(255,143,184,0.22);
    }

    body{
      margin:0;
      min-height:100vh;
      display:grid;
      place-items:center;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: linear-gradient(180deg, #fff0f6, #ffe3ef);
      overflow-y:auto;
      overflow-x:hidden;
      cursor: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='32' height='32'><text x='2' y='22' font-size='20'>%F0%9F%92%97</text></svg>") 4 20, auto;
      -webkit-tap-highlight-color: transparent;
    }

    /* ===== HEART LOADER ===== */
    #loader{
      position:fixed;
      inset:0;
      z-index:99999;
      display:grid;
      place-items:center;
      background: linear-gradient(180deg, #fff0f6, #ffe3ef);
      transition: opacity .35s ease;
    }
    #loader.hidden{ opacity:0; pointer-events:none; }
    #loaderInner{
      position:relative;
      width:min(240px, 72vw);
      aspect-ratio: 1/1;
      display:grid;
      place-items:center;
    }
    #loaderPct{
      position:absolute;
      font-weight:900;
      letter-spacing:.2px;
      color: rgba(178,31,85,0.90);
      font-size:18px;
      text-shadow: 0 10px 24px rgba(255,77,141,0.18);
      user-select:none;
    }
    .heartShape{
      width:160px;
      height:160px;
      transform: rotate(45deg) scale(0.22);
      background: linear-gradient(135deg, var(--pink), var(--pink2));
      border-radius: 18px;
      box-shadow: 0 24px 80px rgba(255,77,141,0.28);
      position:relative;
      will-change: transform;
      transition: transform .08s linear;
    }
    .heartShape::before,
    .heartShape::after{
      content:"";
      position:absolute;
      width:160px;
      height:160px;
      background: inherit;
      border-radius: 50%;
    }
    .heartShape::before{ left:-80px; top:0; }
    .heartShape::after{ top:-80px; left:0; }

    #loaderFlash{
      position:fixed;
      inset:0;
      background: radial-gradient(circle at 50% 50%, rgba(255,255,255,0.95), rgba(255,255,255,0));
      opacity:0;
      pointer-events:none;
      transition: opacity .18s ease;
    }
    #loaderFlash.on{ opacity:1; }

    /* content hidden until loader done */
    #app{ opacity:0; transform: translateY(6px); transition: opacity .35s ease, transform .35s ease; }
    #app.ready{ opacity:1; transform: translateY(0); }

    /* ===== FLOATING HEARTS BG ===== */
    .hearts{ position:fixed; inset:0; pointer-events:none; z-index:0; }
    .heart{
      position:absolute; bottom:-40px; font-size:22px; opacity:0.6;
      animation: floatUp linear infinite;
      filter: drop-shadow(0 10px 18px rgba(255,77,141,0.18));
    }
    @keyframes floatUp{ from{ transform: translateY(0);} to{ transform: translateY(-110vh);} }

    .card{
      width:min(620px, 92vw);
      margin: 26px 0;
      padding:28px;
      border-radius:22px;
      background: rgba(255,255,255,0.55);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border:1px solid var(--border);
      box-shadow:0 20px 60px var(--shadow);
      text-align:center;
      position:relative;
      z-index:2;
    }

    h1{ margin:0 0 8px; font-size:32px; color:var(--dark); }

    #waitMsg{
      display:none;
      margin-bottom:10px;
      font-weight:700;
      color:var(--dark);
    }

    .stage{
      position:relative;
      height:170px;
      border-radius:18px;
      background: rgba(255,143,184,0.15);
      margin-bottom:16px;
      overflow:hidden;
    }

    button{
      border:none;
      border-radius:999px;
      padding:12px 18px;
      font-size:16px;
      font-weight:700;
      cursor:pointer;
      user-select:none;
      touch-action:none;
    }

    #yesBtn{
      background: linear-gradient(135deg, var(--pink), var(--pink2));
      color:white;
      margin-top:56px;
      animation: wiggle 3.5s ease-in-out infinite;
    }
    @keyframes wiggle{
      0%,84%,100%{transform:rotate(0deg)}
      88%{transform:rotate(-2deg)}
      92%{transform:rotate(2deg)}
      96%{transform:rotate(-1deg)}
    }

    #noBtn{
      position:absolute;
      background:white;
      color:var(--dark);
      border:1px solid rgba(255,77,141,0.35);
    }

    #photoWrap{ position:relative; display:none; margin-top:14px; }
    #yesPic, #noPic{
      display:none;
      max-width:100%;
      border-radius:16px;
      box-shadow:0 16px 40px rgba(255,77,141,0.25);
      cursor:pointer;
    }

    #clickMe{
      position:absolute;
      top:-52px;
      left:50%;
      transform:translateX(-50%);
      background: rgba(255,255,255,0.95);
      border:1px solid rgba(255,77,141,0.30);
      color:var(--dark);
      padding:8px 14px;
      border-radius:999px;
      font-weight:900;
      font-size:13px;
      box-shadow:0 10px 24px rgba(255,77,141,0.20);
      display:none;
      animation: bob 1.1s ease-in-out infinite;
      white-space:nowrap;
      z-index:3;
    }
    #clickMe::after{
      content:"";
      position:absolute;
      left:50%;
      bottom:-10px;
      transform:translateX(-50%);
      width:0; height:0;
      border-left:8px solid transparent;
      border-right:8px solid transparent;
      border-top:10px solid rgba(255,255,255,0.95);
      filter: drop-shadow(0 2px 2px rgba(255,77,141,0.25));
    }
    @keyframes bob{
      0%,100%{ transform:translateX(-50%) translateY(0); }
      50%{ transform:translateX(-50%) translateY(-6px); }
    }

    .sparkle{
      position:fixed;
      width:7px; height:7px;
      border-radius:999px;
      background: rgba(255,77,141,0.22);
      box-shadow:
        0 0 10px rgba(255,77,141,0.18),
        0 0 22px rgba(255,143,184,0.14);
      pointer-events:none;
      animation: sparkle 800ms ease-out forwards;
      z-index:9999;
      mix-blend-mode: multiply;
    }
    @keyframes sparkle{
      from{opacity:0.9; transform:translate(-50%,-50%) scale(1)}
      to{opacity:0; transform:translate(-50%,-50%) scale(0.15)}
    }

    .burst{
      position:fixed;
      font-size:20px;
      pointer-events:none;
      animation: burst 900ms ease-out forwards;
      z-index:9999;
    }
    @keyframes burst{
      from{opacity:1; transform:translate(0,0) scale(1)}
      to{opacity:0; transform:translate(var(--x), var(--y)) scale(0.3)}
    }

    #letter{
      display:none;
      width:min(1100px, 94vw);
      margin: 26px 0;
      padding:22px 18px 18px;
      border-radius:22px;
      background: rgba(255,255,255,0.72);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border:1px solid var(--border);
      box-shadow:0 20px 60px var(--shadow);
      position:relative;
      z-index:2;
    }

    #letterHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:12px;
    }

    #letterTitle{ margin:0; color:var(--dark); font-size:22px; letter-spacing:.2px; }

    #langBtn{
      background: rgba(255,77,141,0.12);
      border:1px solid rgba(255,77,141,0.35);
      color:var(--dark);
      padding:10px 14px;
      border-radius:999px;
      font-weight:800;
      cursor:pointer;
      white-space:nowrap;
    }
    #langBtn:hover{ background: rgba(255,77,141,0.18); }

    #letterGrid{
      display:grid;
      grid-template-columns: 1fr;
      gap:16px;
      align-items:start;
    }
    @media (min-width: 980px){
      #letterGrid{ grid-template-columns: 1fr 380px; }
    }

    .rightCol{ display:flex; flex-direction:column; gap:14px; }

    #paper{
      position:relative;
      border-radius:18px;
      overflow:hidden;
      border: 1px solid rgba(255,77,141,0.18);
      background:
        repeating-linear-gradient(
          180deg,
          rgba(255,255,255,0.96) 0px,
          rgba(255,255,255,0.96) 26px,
          rgba(255,77,141,0.06) 27px,
          rgba(255,77,141,0.06) 28px
        );
      box-shadow: 0 18px 45px rgba(255,77,141,0.18);
    }

    #paper::before, #paper::after{
      content:"";
      position:absolute;
      width:78px; height:26px;
      background: rgba(255,255,255,0.55);
      border: 1px solid rgba(255,77,141,0.16);
      box-shadow: 0 10px 18px rgba(255,77,141,0.12);
      transform: rotate(-6deg);
      top:10px;
      z-index:3;
      pointer-events:none;
    }
    #paper::before{ left:14px; }
    #paper::after{ right:14px; transform: rotate(6deg); }

    #letterScroll{
      max-height: 62vh;
      overflow:auto;
      padding:22px 18px 16px;
      position:relative;
      z-index:2;
      scrollbar-width: thin;
    }
    #letterScroll::-webkit-scrollbar{ width:10px; }
    #letterScroll::-webkit-scrollbar-thumb{
      background: rgba(178,31,85,0.28);
      border-radius:999px;
      border: 3px solid rgba(255,255,255,0.55);
    }
    #letterScroll::-webkit-scrollbar-track{ background: transparent; }

    #letterText{
      white-space:pre-wrap;
      line-height:1.7;
      font-size:16px;
      color:var(--paperText);
      font-family: ui-serif, Georgia, "Times New Roman", serif;
    }

    #signature{
      margin-top:18px;
      display:flex;
      flex-direction:column;
      gap:6px;
      align-items:flex-end;
      font-family: ui-serif, Georgia, "Times New Roman", serif;
      color:var(--dark);
    }
    #signature .yours{ font-style:italic; font-weight:600; }
    #signature .name{ font-weight:800; letter-spacing:.2px; }

    .fadeTop, .fadeBottom{
      position:absolute; left:0; right:0;
      height:34px; pointer-events:none;
      z-index:4;
      transition: opacity .18s ease;
    }
    .fadeTop{
      top:0;
      background: linear-gradient(180deg, rgba(255,255,255,0.98), rgba(255,255,255,0));
      opacity:0;
    }
    .fadeBottom{
      bottom:0;
      background: linear-gradient(0deg, rgba(255,255,255,0.98), rgba(255,255,255,0));
      opacity:1;
    }

    .glassCard{
      padding:14px;
      border-radius:22px;
      background: rgba(255,255,255,0.55);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border:1px solid rgba(255,77,141,0.28);
      box-shadow: 0 20px 45px rgba(255,77,141,0.22);
      position:relative;
      overflow:hidden;
    }
    .glassCard::before{
      content:"";
      position:absolute;
      inset:-80px;
      background: radial-gradient(circle at 30% 20%, rgba(255,77,141,0.18), transparent 55%),
                  radial-gradient(circle at 70% 80%, rgba(255,143,184,0.18), transparent 55%);
      pointer-events:none;
    }

    .label{
      position:relative;
      text-align:center;
      margin-bottom:10px;
      font-weight:900;
      color:var(--dark);
      font-size:14px;
      letter-spacing:0.2px;
    }

    .glassCard iframe{ position:relative; border-radius:14px; }

    .chessTop{
      display:flex;
      gap:8px;
      align-items:center;
      justify-content:space-between;
      margin-bottom:10px;
      position:relative;
      z-index:2;
    }
    .modeBtns{ display:flex; gap:8px; }
    .modeBtn{
      border:none;
      border-radius:999px;
      padding:8px 10px;
      font-size:12px;
      font-weight:900;
      cursor:pointer;
      background: rgba(255,77,141,0.12);
      border:1px solid rgba(255,77,141,0.28);
      color:var(--dark);
      white-space:nowrap;
    }
    .modeBtn.active{
      background: linear-gradient(135deg, rgba(255,77,141,0.30), rgba(255,143,184,0.26));
      border-color: rgba(255,77,141,0.40);
    }

    .capturedRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin: 4px 0 10px;
      position:relative;
      z-index:2;
    }
    .caps{
      flex:1;
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      align-items:center;
      min-height:18px;
    }
    .caps.right{ justify-content:flex-end; }
    .capIcon{
      width:16px; height:16px;
      border-radius:6px;
      background: rgba(255,255,255,0.55);
      border:1px solid rgba(255,77,141,0.22);
      display:grid;
      place-items:center;
      font-size:11px;
      line-height:1;
      box-shadow: 0 8px 18px rgba(255,77,141,0.12);
    }

    .chessboard{
      position:relative;
      width:100%;
      aspect-ratio: 1 / 1;
      display:grid;
      grid-template-columns: repeat(8, 1fr);
      border-radius:18px;
      overflow:hidden;
      border:1px solid rgba(255,77,141,0.22);
      box-shadow: 0 18px 40px rgba(255,77,141,0.18);
      background: rgba(255,255,255,0.6);

      transform: scale(0.92);
      transform-origin: top center;
      margin-top:-6px;
      margin-bottom:-10px;
    }

    .sq{
      display:grid;
      place-items:center;
      user-select:none;
      position:relative;
      cursor:pointer;
      touch-action: manipulation;
    }

    .light{ background: var(--boardLight); }
    .darkSq{ background: var(--boardDark); }

    .sq::after{
      content:"";
      position:absolute;
      inset:0;
      pointer-events:none;
      opacity:0;
      transition: opacity .12s ease;
      background: radial-gradient(circle at 50% 50%, rgba(255,77,141,0.20), transparent 60%);
    }
    .sq.sel::after{
      opacity:1;
      background: radial-gradient(circle at 50% 50%, rgba(255,77,141,0.28), transparent 62%);
    }
    .sq.hl::after{
      opacity:1;
      background: radial-gradient(circle at 50% 50%, rgba(178,31,85,0.22), transparent 62%);
    }

    .pieceSvg{
      width:70%;
      height:70%;
      filter: drop-shadow(0 6px 10px rgba(255,77,141,0.18));
    }

    .chessRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-top:10px;
      position:relative;
      z-index:2;
    }

    .status{
      flex:1;
      font-size:12.5px;
      font-weight:900;
      color: rgba(178,31,85,0.92);
      text-align:left;
      opacity:0.95;
    }

    .miniBtn{
      border:none;
      border-radius:999px;
      padding:9px 12px;
      font-size:13px;
      font-weight:900;
      cursor:pointer;
      background: rgba(255,77,141,0.12);
      border:1px solid rgba(255,77,141,0.28);
      color:var(--dark);
      white-space:nowrap;
    }
    .miniBtn:hover{ background: rgba(255,77,141,0.18); }

    .capHeart{
      position:absolute;
      font-size:16px;
      pointer-events:none;
      animation: capPop 700ms ease-out forwards;
      filter: drop-shadow(0 10px 18px rgba(255,77,141,0.25));
    }
    @keyframes capPop{
      from{ opacity:1; transform: translate(-50%,-50%) scale(1); }
      to{ opacity:0; transform: translate(calc(-50% + var(--x)), calc(-50% + var(--y))) scale(0.35); }
    }
  </style>
</head>

<body>
  <div id="loader" aria-hidden="true">
    <div id="loaderFlash"></div>
    <div id="loaderInner">
      <div class="heartShape" id="loaderHeart"></div>
      <div id="loaderPct">0%</div>
    </div>
  </div>

  <div id="app">
    <div class="hearts">
      <div class="heart" style="left:10%; animation-duration:12s;">ðŸ’—</div>
      <div class="heart" style="left:25%; animation-duration:10s;">ðŸ’–</div>
      <div class="heart" style="left:40%; animation-duration:14s;">ðŸ’˜</div>
      <div class="heart" style="left:55%; animation-duration:11s;">ðŸ’ž</div>
      <div class="heart" style="left:70%; animation-duration:13s;">ðŸ’“</div>
      <div class="heart" style="left:85%; animation-duration:12s;">ðŸ’—</div>
    </div>

    <div class="card" id="card">
      <h1>will you be my valentine? &lt;3</h1>
      <div id="waitMsg">thinking?</div>

      <div class="stage" id="stage">
        <button id="yesBtn" type="button">yes</button>
        <button id="noBtn" type="button">no</button>
      </div>

      <div id="photoWrap">
        <div id="clickMe">tap the photo</div>
        <img id="yesPic" src="yes.jpg" alt="yes">
        <img id="noPic" src="no.jpg" alt="no">
      </div>
    </div>

    <div id="letter">
      <div id="letterHeader">
        <h2 id="letterTitle">for luca</h2>
        <button id="langBtn" type="button">polish</button>
      </div>

      <div id="letterGrid">
        <div id="paper">
          <div class="fadeTop" id="fadeTop"></div>
          <div class="fadeBottom" id="fadeBottom"></div>

          <div id="letterScroll">
            <div id="letterText"></div>

            <div id="signature">
              <div class="yours" id="sigYours">yours,</div>
              <div class="name" id="sigName">marta</div>
            </div>
          </div>
        </div>

        <div class="rightCol">
          <div class="glassCard">
            <div class="label">music that makes me think of you</div>

            <iframe data-testid="embed-iframe"
              style="border-radius:12px"
              src="https://open.spotify.com/embed/playlist/2wSxwuUANGEvMWPhouZKA0?utm_source=generator"
              width="100%"
              height="152"
              frameBorder="0"
              allowfullscreen=""
              allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture"
              loading="lazy"></iframe>
          </div>

          <div class="glassCard">
            <div class="label">one game?</div>

            <div class="chessTop">
              <div class="modeBtns">
                <button class="modeBtn active" id="martaMode" type="button">marta mode</button>
                <button class="modeBtn" id="lucaMode" type="button">luca mode</button>
              </div>
              <button class="miniBtn" id="newGame" type="button">new game</button>
            </div>

            <div class="capturedRow">
              <div class="caps" id="capsYou"></div>
              <div class="caps right" id="capsCpu"></div>
            </div>

            <div class="chessboard" id="board"></div>

            <div class="chessRow">
              <div class="status" id="status"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="chess.min.js"></script>

  <script>
    /* ===== LOADER ===== */
    const loader = document.getElementById("loader");
    const loaderHeart = document.getElementById("loaderHeart");
    const loaderPct = document.getElementById("loaderPct");
    const loaderFlash = document.getElementById("loaderFlash");
    const app = document.getElementById("app");

    const prefersReduced = window.matchMedia && window.matchMedia("(prefers-reduced-motion: reduce)").matches;

    function finishLoader(){
      if(!prefersReduced){
        loaderFlash.classList.add("on");
        setTimeout(() => loaderFlash.classList.remove("on"), 160);
      }
      loader.classList.add("hidden");
      app.classList.add("ready");
      setTimeout(() => loader.remove(), 450);
    }

   (function runLoader(){
  const prefersReduced =
    window.matchMedia &&
    window.matchMedia("(prefers-reduced-motion: reduce)").matches;

  if(prefersReduced){
    loaderPct.textContent = "100%";
    loaderHeart.style.transform = "rotate(45deg) scale(12)";
    finishLoader();
    return;
  }

  let pct = 0;

  // slower + intentional
  const total = 2300 + Math.random() * 300; // 2.3â€“2.6s
  const start = performance.now();

  function tick(now){
    const t = Math.min(1, (now - start) / total);
    const eased = 1 - Math.pow(1 - t, 3); // ease-out

    pct = Math.round(eased * 100);
    loaderPct.textContent = pct + "%";

    // grow steadily
    const scale = 0.18 + eased * 5.6;
    loaderHeart.style.transform = `rotate(45deg) scale(${scale})`;

    if(t < 1){
      requestAnimationFrame(tick);
    }else{
      // final cinematic expansion
      loaderPct.textContent = "100%";
      loaderPct.style.opacity = "0";

      loaderHeart.style.transition = "transform 420ms ease-in";
      loaderHeart.style.transform = "rotate(45deg) scale(18)";

      setTimeout(() => {
        finishLoader();
      }, 420);
    }
  }

  requestAnimationFrame(tick);
})();

      let pct = 0;
      const minMs = 900;
      const maxMs = 1600;
      const total = Math.floor(minMs + Math.random() * (maxMs - minMs));
      const start = performance.now();

      function tick(now){
        const t = Math.min(1, (now - start) / total);
        const eased = 1 - Math.pow(1 - t, 3);

        pct = Math.round(eased * 100);
        loaderPct.textContent = pct + "%";

        const scale = 0.22 + eased * 6.2;
        loaderHeart.style.transform = `rotate(45deg) scale(${scale})`;

        if(t < 1){
          requestAnimationFrame(tick);
        }else{
          loaderPct.textContent = "100%";
          loaderHeart.style.transform = "rotate(45deg) scale(7.2)";
          setTimeout(finishLoader, 110);
        }
      }
      requestAnimationFrame(tick);
    })();

    /* ===== EXISTING APP ===== */
    const yesBtn = document.getElementById("yesBtn");
    const noBtn  = document.getElementById("noBtn");
    const stage  = document.getElementById("stage");
    const yesPic = document.getElementById("yesPic");
    const noPic  = document.getElementById("noPic");
    const waitMsg = document.getElementById("waitMsg");

    const photoWrap = document.getElementById("photoWrap");
    const clickMe = document.getElementById("clickMe");

    const card = document.getElementById("card");
    const letter = document.getElementById("letter");

    const langBtn = document.getElementById("langBtn");
    const letterText = document.getElementById("letterText");
    const letterTitle = document.getElementById("letterTitle");
    const sigYours = document.getElementById("sigYours");
    const sigName = document.getElementById("sigName");

    const letterScroll = document.getElementById("letterScroll");
    const fadeTop = document.getElementById("fadeTop");
    const fadeBottom = document.getElementById("fadeBottom");

    const youShadeName = getComputedStyle(document.documentElement).getPropertyValue("--youShadeName").trim().replaceAll('"','');
    const cpuShadeName = getComputedStyle(document.documentElement).getPropertyValue("--cpuShadeName").trim().replaceAll('"','');

    const englishLetter = `It might be cheesy. But as the self-appointed president of the Anti-Nonchalance Club, Iâ€™m obligated to do this.
I donâ€™t think I ever told you about the first time I saw you. And even if I did, youâ€™re going to hear it again. I was walking back to the hostel after some talk show when I noticed you, standing there, talking to another guy. That moment is the reason I went to the welcome party at all. I thought you were cute, but I quietly accepted my fate that this would lead nowhere. Still, somehow, those next two days turned into two of the best days of my life - and I didnâ€™t expect that at all.
At first, you seemed interested. Then distant. Youâ€™d reply, but after six hours of leaving me on read. You said you wanted a stable emotional connection, and then youâ€™d grow unreasonably cold. Hot and cold. I wonâ€™t pretend that didnâ€™t scare me. It touched something old in me - the part thatâ€™s always waiting for things to end suddenly, without warning. Maybe thatâ€™s why I sometimes feel like this could disappear in a second. Maybe Iâ€™m still learning what secure connection looks like, and I mistake calm for loss. Especially with the distance - itâ€™s hard not to doubt when you choose someone so far away, when there are girls within armâ€™s reach. (and you have Venus in Gemini, and Tiktok says that means cheating.)
But Iâ€™m trying. Iâ€™m unlearning patterns that no longer serve me, because I donâ€™t want my fears to be louder than my feelings. And I know how heavy that kind of doubt can feel when itâ€™s directed at you.
You are the smartest and funniest person I know, and I say that with complete sincerity. Iâ€™ve never met anyone I could talk to like this - someone who challenges me intellectually, teaches me things, and still keeps up with my chaotic imagination and endless curiosity. Someone who wants to talk about art, theatre, and the meaning of life without irony. Someone who listens to my terrible poems and treats them like they matter.
Opening up in English is hard for me. I have to build whole worlds just to explain one emotion. And yet with you, it feels safer. Because of your patience, your empathy, the way you actually listen instead of waiting to respond. You make space for me without making me feel like I take up too much of it.
I love how you care about your friends, how intentionally you show up for them, how you value shared time, how you treat Peanut. It sounds small, but to me it says everything. I love how seriously you take your future - your work, your education, the discipline and effort you put into becoming who you want to be. You have good things ahead of you, not because of luck or money or the right people, but because youâ€™re building them yourself. And I feel genuinely lucky to be close enough to witness that.
You make me want to be better - not out of fear of losing you, but out of admiration. You never make me feel small for knowing less, for not being educated in your field, for wanting a life thatâ€™s gentler or less complicated. I love how safe I feel with you, even across the distance. How, with you, I finally donâ€™t feel the need to control everything just to feel okay.
We havenâ€™t known each other for long - but Iâ€™m choosing to be curious instead of afraid. Iâ€™m excited about getting to know you. About learning how to trust, together, in a way that feels real, intentional, and lasting - no matter the distance, no matter the uncertainty, as long as we keep choosing each other along the way.`;

    const polishLetter = `Pewnie brzmi to trochÄ™ banalnie. Ale jako samozwaÅ„cza prezeska Klubu Anty-Nonchalancji jestem wÅ‚aÅ›ciwie zobowiÄ…zana, Å¼eby to zrobiÄ‡.
Nie wiem, czy kiedykolwiek opowiadaÅ‚am Ci o pierwszym razie, kiedy CiÄ™ zobaczyÅ‚am. A nawet jeÅ›li - i tak usÅ‚yszysz to jeszcze raz. WracaÅ‚am do hostelu po jakimÅ› talk show, kiedy CiÄ™ zauwaÅ¼yÅ‚am: staÅ‚eÅ› tam i rozmawiaÅ‚eÅ› z innym chÅ‚opakiem. To wÅ‚aÅ›nie ten moment sprawiÅ‚, Å¼e w ogÃ³le poszÅ‚am na imprezÄ™ powitalnÄ…. PomyÅ›laÅ‚am, Å¼e jesteÅ› uroczy, ale po cichu pogodziÅ‚am siÄ™ z tym, Å¼e to donikÄ…d nie doprowadzi. A jednak - w jakiÅ› sposÃ³b te kolejne dwa dni staÅ‚y siÄ™ jednymi z najlepszych dni w moim Å¼yciu. I zupeÅ‚nie siÄ™ tego nie spodziewaÅ‚am.
Na poczÄ…tku wydawaÅ‚eÅ› siÄ™ zainteresowany. Potem zdystansowany. OdpisywaÅ‚eÅ›, ale po szeÅ›ciu godzinach zostawiania mnie na wyÅ›wietlonym. MÃ³wiÅ‚eÅ›, Å¼e chcesz stabilnej emocjonalnej relacji, a potem stawaÅ‚eÅ› siÄ™ oschÅ‚y. CiepÅ‚o - zimno. Nie bÄ™dÄ™ udawaÄ‡, Å¼e mnie to nie przestraszyÅ‚o. DotknÄ™Å‚o to czegoÅ› we mnie â€“ tej czÄ™Å›ci, ktÃ³ra zawsze czeka, aÅ¼ wszystko nagle siÄ™ skoÅ„czy, bez ostrzeÅ¼enia. MoÅ¼e dlatego czasem czujÄ™, Å¼e to wszystko moÅ¼e zniknÄ…Ä‡ w jednej chwili. MoÅ¼e wciÄ…Å¼ uczÄ™ siÄ™, jak wyglÄ…da bezpieczna relacja i mylÄ™ spokÃ³j z utratÄ…. ZwÅ‚aszcza na odlegÅ‚oÅ›Ä‡ - trudno nie mieÄ‡ wÄ…tpliwoÅ›ci, kiedy wybierasz kogoÅ› tak daleko, majÄ…c dziewczyny na wyciÄ…gniÄ™cie rÄ™ki (a do tego masz Wenus w BliÅºniÄ™tach, a Tiktok twierdzi, Å¼e to oznacza zdradzanie).
Ale prÃ³bujÄ™. Oduczam siÄ™ schematÃ³w, ktÃ³re juÅ¼ mi nie sÅ‚uÅ¼Ä…, bo nie chcÄ™, Å¼eby moje lÄ™ki byÅ‚y gÅ‚oÅ›niejsze niÅ¼ moje uczucia. I wiem, jak ciÄ™Å¼ki moÅ¼e byÄ‡ taki brak zaufania, kiedy jest skierowany w TwojÄ… stronÄ™.
JesteÅ› najinteligentniejszÄ… i najzabawniejszÄ… osobÄ…, jakÄ… znam â€“ i mÃ³wiÄ™ to z peÅ‚nym przekonaniem. Nigdy nie spotkaÅ‚am kogoÅ›, z kim mogÅ‚abym tak rozmawiaÄ‡: kogoÅ›, kto intelektualnie mnie stymuluje, uczy mnie nowych rzeczy, a jednoczeÅ›nie nadÄ…Å¼a za mojÄ… chaotycznÄ… wyobraÅºniÄ… i niekoÅ„czÄ…cÄ… siÄ™ ciekawoÅ›ciÄ…. KogoÅ›, kto chce rozmawiaÄ‡ o sztuce, teatrze i sensie Å¼ycia bez ironii. KogoÅ›, kto sÅ‚ucha moich kiepskich wierszy i traktuje je tak, jakby coÅ› znaczyÅ‚y.
Otwieranie siÄ™ po angielsku jest dla mnie trudne. MuszÄ™ budowaÄ‡ caÅ‚e Å›wiaty, Å¼eby wyjaÅ›niÄ‡ jednÄ… emocjÄ™. A jednak z TobÄ… czujÄ™ siÄ™ bezpieczniej. DziÄ™ki Twojej cierpliwoÅ›ci, empatii, przez to, Å¼e naprawdÄ™ sÅ‚uchasz, zamiast tylko czekaÄ‡ na swojÄ… kolej, Å¼eby odpowiedzieÄ‡. Tworzysz dla mnie miejsce, nie sprawiajÄ…c, Å¼e czujÄ™ siÄ™, jakbym zajmowaÅ‚a go za duÅ¼o.
Uwielbiam to, jak dbasz o swoich przyjaciÃ³Å‚, w jak Å›wiadomy sposÃ³b przy nich jesteÅ›, jak cenisz wspÃ³lnie spÄ™dzony czas, jak traktujesz Peanut. Brzmi to maÅ‚ostkowo, ale dla mnie mÃ³wi wszystko. Kocham to, jak powaÅ¼nie podchodzisz do swojej przyszÅ‚oÅ›ci â€“ do pracy, edukacji, do dyscypliny i wysiÅ‚ku, ktÃ³re wkÅ‚adasz w stawanie siÄ™ tym, kim chcesz byÄ‡. Masz przed sobÄ… Å›wietnÄ… przyszÅ‚oÅ›Ä‡ nie dlatego, Å¼e masz szczÄ™Å›cie, pieniÄ…dze czy odpowiednich ludzi, ale dlatego, Å¼e sam jÄ… budujesz. I czujÄ™ siÄ™ naprawdÄ™ szczÄ™Å›liwa, mogÄ…c byÄ‡ wystarczajÄ…co blisko, by to obserwowaÄ‡.
Sprawiasz, Å¼e chcÄ™ stawaÄ‡ siÄ™ lepszÄ… wersjÄ… siebie â€“ nie ze strachu przed utratÄ… Ciebie, ale z podziwu. Nigdy nie sprawiasz, Å¼e czujÄ™ siÄ™ mniejsza, bo wiem mniej, bo nie jestem wyksztaÅ‚cona w Twojej dziedzinie, bo chcÄ™ Å¼ycia, ktÃ³re jest mniej skomplikowane. Kocham to, jak bezpiecznie czujÄ™ siÄ™ z TobÄ…, nawet mimo dzielÄ…cej nas odlegÅ‚oÅ›ci. Jak przy Tobie po raz pierwszy od dawna nie czujÄ™ potrzeby kontrolowania wszystkiego.
Nie znamy siÄ™ dÅ‚ugo, ale wybieram ciekawoÅ›Ä‡ zamiast strachu. Nie mogÄ™ siÄ™ doczekaÄ‡, by dalej CiÄ™ poznawaÄ‡. By uczyÄ‡ siÄ™ zaufania razem, w sposÃ³b, ktÃ³ry jest prawdziwy, Å›wiadomy i trwaÅ‚y â€“ bez wzglÄ™du na dystans, bez wzglÄ™du na niepewnoÅ›Ä‡, tak dÅ‚ugo, jak za kaÅ¼dym razem bÄ™dziemy siÄ™ nawzajem wybieraÄ‡.`;

    let waitTimer = setTimeout(() => { waitMsg.style.display = "block"; }, 5000);
    function resetWait(){
      clearTimeout(waitTimer);
      waitMsg.style.display = "none";
      waitTimer = setTimeout(() => { waitMsg.style.display = "block"; }, 5000);
    }

    function moveNo(e){
      if(e) e.preventDefault();
      resetWait();
      const maxX = Math.max(0, stage.clientWidth  - noBtn.offsetWidth);
      const maxY = Math.max(0, stage.clientHeight - noBtn.offsetHeight);
      noBtn.style.left = (Math.random() * maxX) + "px";
      noBtn.style.top  = (Math.random() * maxY) + "px";
    }
    noBtn.addEventListener("mouseenter", moveNo, { passive:false });
    noBtn.addEventListener("mousedown", moveNo, { passive:false });
    noBtn.addEventListener("click", moveNo, { passive:false });
    noBtn.addEventListener("touchstart", moveNo, { passive:false });
    noBtn.addEventListener("pointerdown", moveNo, { passive:false });
    noBtn.addEventListener("pointerenter", moveNo, { passive:false });

    function heartExplosion(x, y){
      const hearts = ["ðŸ’—","ðŸ’–","ðŸ’˜","ðŸ’ž","ðŸ’“"];
      for(let i=0;i<20;i++){
        const h = document.createElement("div");
        h.className = "burst";
        h.textContent = hearts[Math.floor(Math.random()*hearts.length)];
        h.style.left = x + "px";
        h.style.top  = y + "px";
        h.style.setProperty("--x", (Math.random()*240-120)+"px");
        h.style.setProperty("--y", (Math.random()*-260-70)+"px");
        document.body.appendChild(h);
        setTimeout(() => h.remove(), 900);
      }
    }

    let clickTimer = null;
    yesBtn.addEventListener("click", (e) => {
      resetWait();
      photoWrap.style.display = "block";
      yesPic.style.display = "block";
      noPic.style.display = "none";

      clickMe.style.display = "none";
      if(clickTimer) clearTimeout(clickTimer);
      clickTimer = setTimeout(() => { clickMe.style.display = "block"; }, 5000);

      const cx = (e && typeof e.clientX === "number") ? e.clientX : (window.innerWidth/2);
      const cy = (e && typeof e.clientY === "number") ? e.clientY : (window.innerHeight/2);
      heartExplosion(cx, cy);
    });

    function updateFades(){
      const top = letterScroll.scrollTop;
      const max = letterScroll.scrollHeight - letterScroll.clientHeight;
      fadeTop.style.opacity = top > 6 ? "1" : "0";
      fadeBottom.style.opacity = top < max - 6 ? "1" : "0";
    }
    letterScroll.addEventListener("scroll", updateFades);

    let isPolish = false;
    function applyLanguage(){
      if(isPolish){
        letterTitle.textContent = "dla luca";
        sigYours.textContent = "twoja,";
        sigName.textContent = "marta";
        langBtn.textContent = "english";
        letterText.textContent = polishLetter;
      }else{
        letterTitle.textContent = "for luca";
        sigYours.textContent = "yours,";
        sigName.textContent = "marta";
        langBtn.textContent = "polish";
        letterText.textContent = englishLetter;
      }
      letterScroll.scrollTop = 0;
      updateFades();
    }
    langBtn.addEventListener("click", () => {
      isPolish = !isPolish;
      applyLanguage();
    });

    yesPic.addEventListener("click", () => {
      if(clickTimer) clearTimeout(clickTimer);
      card.style.display = "none";
      letter.style.display = "block";
      applyLanguage();
      updateFades();
      initChessOnce();
      setTimeout(() => { window.scrollTo({ top: 0, behavior: "smooth" }); }, 50);
    });

    let last = 0;
    function spawnSparkle(x, y){
      const s = document.createElement("div");
      s.className = "sparkle";
      s.style.left = x + "px";
      s.style.top  = y + "px";
      document.body.appendChild(s);
      setTimeout(() => s.remove(), 900);
    }
    document.addEventListener("mousemove", (e) => {
      const now = performance.now();
      if(now - last < 22) return;
      last = now;
      spawnSparkle(e.clientX, e.clientY);
      if(Math.random() < 0.18) spawnSparkle(e.clientX + (Math.random()*14-7), e.clientY + (Math.random()*14-7));
    });
    document.addEventListener("touchmove", (e) => {
      const t = e.touches && e.touches[0];
      if(!t) return;
      const now = performance.now();
      if(now - last < 24) return;
      last = now;
      spawnSparkle(t.clientX, t.clientY);
      if(Math.random() < 0.18) spawnSparkle(t.clientX + (Math.random()*14-7), t.clientY + (Math.random()*14-7));
    }, { passive:true });

    moveNo();
    applyLanguage();

    /* ===== MINI CHESS ===== */
    const boardEl = document.getElementById("board");
    const statusEl = document.getElementById("status");
    const newGameBtn = document.getElementById("newGame");
    const martaModeBtn = document.getElementById("martaMode");
    const lucaModeBtn = document.getElementById("lucaMode");

    const capsYouEl = document.getElementById("capsYou");
    const capsCpuEl = document.getElementById("capsCpu");

    let chess = null;
    let selected = null;
    let legalTargets = new Set();
    let thinking = false;

    let aiDepth = 1;
    const capIcons = { p:"â™Ÿ", n:"â™ž", b:"â™", r:"â™œ", q:"â™›", k:"â™š" };

    let capsYou = [];
    let capsCpu = [];

    function setMode(depth){
      aiDepth = depth;
      if(depth === 1){
        martaModeBtn.classList.add("active");
        lucaModeBtn.classList.remove("active");
      }else{
        lucaModeBtn.classList.add("active");
        martaModeBtn.classList.remove("active");
      }
      updateGameStateText();
    }
    martaModeBtn.addEventListener("click", () => setMode(1));
    lucaModeBtn.addEventListener("click", () => setMode(3));

    function renderCaptured(){
      capsYouEl.innerHTML = capsYou.map(t => `<span class="capIcon">${capIcons[t] || "â™Ÿ"}</span>`).join("");
      capsCpuEl.innerHTML = capsCpu.map(t => `<span class="capIcon">${capIcons[t] || "â™Ÿ"}</span>`).join("");
    }

    function isGameOver(g){
      return (typeof g.isGameOver === "function") ? g.isGameOver()
           : (typeof g.game_over === "function") ? g.game_over()
           : false;
    }
    function inCheckmate(g){
      return (typeof g.isCheckmate === "function") ? g.isCheckmate()
           : (typeof g.in_checkmate === "function") ? g.in_checkmate()
           : false;
    }
    function inDraw(g){
      const a = (typeof g.isDraw === "function") ? g.isDraw() : false;
      const b = (typeof g.in_draw === "function") ? g.in_draw() : false;
      const c = (typeof g.isStalemate === "function") ? g.isStalemate() : false;
      const d = (typeof g.in_stalemate === "function") ? g.in_stalemate() : false;
      const e = (typeof g.isThreefoldRepetition === "function") ? g.isThreefoldRepetition() : false;
      const f = (typeof g.in_threefold_repetition === "function") ? g.in_threefold_repetition() : false;
      const h = (typeof g.isInsufficientMaterial === "function") ? g.isInsufficientMaterial() : false;
      const i = (typeof g.insufficient_material === "function") ? g.insufficient_material() : false;
      return a || b || c || d || e || f || h || i;
    }
    function inCheck(g){
      return (typeof g.isCheck === "function") ? g.isCheck()
           : (typeof g.in_check === "function") ? g.in_check()
           : false;
    }

    function squareColor(file, rank){ return ((file + rank) % 2 === 0) ? "light" : "darkSq"; }

    function clearSelectionUI(){
      selected = null;
      legalTargets.clear();
      [...boardEl.querySelectorAll(".sq")].forEach(s => s.classList.remove("sel","hl"));
    }

    function setStatus(text){ statusEl.textContent = text; }

    function materialEval(game){
      const vals = { p:100, n:320, b:330, r:500, q:900, k:0 };
      let score = 0;
      const b = game.board();
      for(const row of b){
        for(const p of row){
          if(!p) continue;
          const v = vals[p.type] || 0;
          score += (p.color === "w") ? v : -v;
        }
      }
      return score;
    }

    function pickComputerMove(game, depth){
      const moves = game.moves({ verbose:true });
      if(moves.length === 0) return null;

      function negamax(d){
        if(d === 0 || isGameOver(game)) return materialEval(game);
        let best = -Infinity;
        const ms = game.moves({ verbose:true });
        for(const m of ms){
          game.move(m);
          const val = -negamax(d - 1);
          game.undo();
          if(val > best) best = val;
        }
        return best;
      }

      let bestMove = moves[0];
      let bestScore = Infinity;
      for(const m of moves){
        game.move(m);
        const score = negamax(depth - 1);
        game.undo();
        if(score < bestScore){
          bestScore = score;
          bestMove = m;
        }
      }
      return bestMove;
    }

    function pieceSvg(type, color){
      const fill = color === "w"
        ? getComputedStyle(document.documentElement).getPropertyValue("--youPiece").trim()
        : getComputedStyle(document.documentElement).getPropertyValue("--cpuPiece").trim();

      const stroke = color === "w"
        ? "rgba(255,255,255,0.55)"
        : "rgba(255,255,255,0.18)";

      const gid = "g_" + type + "_" + color;

      const svg = (shape) => `
        <svg class="pieceSvg" viewBox="0 0 100 100" aria-hidden="true">
          <defs>
            <linearGradient id="${gid}" x1="0" x2="1">
              <stop offset="0" stop-color="${fill}" stop-opacity="0.98"/>
              <stop offset="1" stop-color="${fill}" stop-opacity="0.70"/>
            </linearGradient>
          </defs>
          <g fill="url(#${gid})" stroke="${stroke}" stroke-width="3" stroke-linejoin="round">
            ${shape}
          </g>
        </svg>
      `;

      switch(type){
        case "p": return svg(`
          <circle cx="50" cy="38" r="16"/>
          <rect x="36" y="54" width="28" height="10" rx="5"/>
          <rect x="28" y="66" width="44" height="12" rx="6"/>
        `);
        case "r": return svg(`
          <rect x="30" y="26" width="40" height="16" rx="6"/>
          <rect x="34" y="42" width="32" height="30" rx="10"/>
          <rect x="26" y="70" width="48" height="12" rx="6"/>
        `);
        case "n": return svg(`
          <path d="M32 74 C30 52, 40 34, 58 30 C68 28, 74 34, 70 44
                   C66 56, 52 56, 50 62 C48 68, 56 70, 64 70 L64 80 L32 80 Z"/>
          <circle cx="58" cy="40" r="4" fill="rgba(255,255,255,0.75)" stroke="none"/>
        `);
        case "b": return svg(`
          <ellipse cx="50" cy="46" rx="18" ry="22"/>
          <rect x="44" y="28" width="12" height="36" rx="6" fill="rgba(255,255,255,0.18)" stroke="none"/>
          <rect x="30" y="70" width="40" height="12" rx="6"/>
        `);
        case "q": return svg(`
          <path d="M30 38 L38 30 L50 40 L62 30 L70 38 L66 56 Q50 66 34 56 Z"/>
          <rect x="30" y="58" width="40" height="10" rx="5"/>
          <rect x="26" y="70" width="48" height="12" rx="6"/>
          <circle cx="38" cy="30" r="4" fill="rgba(255,255,255,0.75)" stroke="none"/>
          <circle cx="62" cy="30" r="4" fill="rgba(255,255,255,0.75)" stroke="none"/>
        `);
        case "k": return svg(`
          <rect x="46" y="22" width="8" height="22" rx="4"/>
          <rect x="39" y="30" width="22" height="8" rx="4"/>
          <path d="M34 52 Q50 34 66 52 L62 68 Q50 76 38 68 Z"/>
          <rect x="28" y="70" width="44" height="12" rx="6"/>
        `);
        default: return "";
      }
    }

    function renderBoard(){
      if(!chess) return;
      const b = chess.board();
      boardEl.innerHTML = "";

      for(let r = 0; r < 8; r++){
        for(let f = 0; f < 8; f++){
          const sq = document.createElement("div");
          sq.className = "sq " + squareColor(f, r);

          const fileChar = "abcdefgh"[f];
          const rankChar = String(8 - r);
          const name = fileChar + rankChar;
          sq.dataset.square = name;

          const p = b[r][f];
          if(p){
            sq.innerHTML = pieceSvg(p.type, p.color);
          }
          boardEl.appendChild(sq);
        }
      }

      if(selected){
        const selEl = boardEl.querySelector(`.sq[data-square="${selected}"]`);
        if(selEl) selEl.classList.add("sel");
        for(const t of legalTargets){
          const tEl = boardEl.querySelector(`.sq[data-square="${t}"]`);
          if(tEl) tEl.classList.add("hl");
        }
      }
    }

    function updateGameStateText(){
      if(!chess) return;

      if(inCheckmate(chess)){
        setStatus(chess.turn() === "w" ? "checkmate â€” you lost ðŸ˜­" : "checkmate â€” you won ðŸ’—");
        return;
      }
      if(inDraw(chess)){
        setStatus("draw ðŸ¤");
        return;
      }
      if(inCheck(chess)){
        setStatus(chess.turn() === "w"
          ? `your move (${youShadeName}) â€” (check!)`
          : `computer (${cpuShadeName}) â€” (check!)`
        );
        return;
      }
      setStatus(chess.turn() === "w"
        ? `your move (${youShadeName})`
        : `computer (${cpuShadeName}) is thinkingâ€¦ (${aiDepth === 1 ? "marta mode" : "luca mode"})`
      );
    }

    function captureHeartsAtSquare(square){
      const el = boardEl.querySelector(`.sq[data-square="${square}"]`);
      if(!el) return;

      const hearts = ["ðŸ’—","ðŸ’–","ðŸ’˜","ðŸ’ž","ðŸ’“"];
      const rect = el.getBoundingClientRect();

      for(let i=0;i<9;i++){
        const h = document.createElement("div");
        h.className = "capHeart";
        h.textContent = hearts[Math.floor(Math.random()*hearts.length)];
        h.style.left = (rect.left + rect.width/2) + "px";
        h.style.top  = (rect.top  + rect.height/2) + "px";
        h.style.setProperty("--x", (Math.random()*90 - 45) + "px");
        h.style.setProperty("--y", (Math.random()*-110 - 25) + "px");
        document.body.appendChild(h);
        setTimeout(() => h.remove(), 720);
      }
    }

    function doComputerMove(){
      if(!chess || thinking) return;
      if(chess.turn() !== "b") return;
      if(isGameOver(chess)) return;

      thinking = true;
      updateGameStateText();

      setTimeout(() => {
        try{
          const best = pickComputerMove(chess, aiDepth);
          const cm = best ? chess.move(best) : null;
          renderBoard();
          if(cm && cm.captured){
            capsCpu.push(cm.captured);
            renderCaptured();
            captureHeartsAtSquare(cm.to);
          }
        }catch(err){
          const ms = chess.moves({ verbose:true });
          const m = ms.length ? ms[Math.floor(Math.random()*ms.length)] : null;
          const cm = m ? chess.move(m) : null;
          renderBoard();
          if(cm && cm.captured){
            capsCpu.push(cm.captured);
            renderCaptured();
            captureHeartsAtSquare(cm.to);
          }
        }
        thinking = false;
        updateGameStateText();
      }, 260);
    }

    function tryPlayerClick(square){
      if(!chess || thinking) return;
      if(chess.turn() !== "w") return;

      const piece = chess.get(square);

      if(!selected){
        if(piece && piece.color === "w"){
          selected = square;
          legalTargets = new Set(chess.moves({ square:selected, verbose:true }).map(m => m.to));
          renderBoard();
        }
        return;
      }

      if(square === selected){
        clearSelectionUI();
        renderBoard();
        return;
      }

      const move = chess.move({ from:selected, to:square, promotion:"q" });
      if(move){
        const wasCapture = !!move.captured;
        const toSq = move.to;

        clearSelectionUI();
        renderBoard();

        if(wasCapture){
          capsYou.push(move.captured);
          renderCaptured();
          captureHeartsAtSquare(toSq);
        }

        updateGameStateText();
        doComputerMove();
      }else{
        if(piece && piece.color === "w"){
          selected = square;
          legalTargets = new Set(chess.moves({ square:selected, verbose:true }).map(m => m.to));
          renderBoard();
          return;
        }
        clearSelectionUI();
        renderBoard();
      }
    }

    function wireBoardClicks(){
      boardEl.addEventListener("click", (e) => {
        const sq = e.target.closest(".sq");
        if(!sq) return;
        tryPlayerClick(sq.dataset.square);
      });
      boardEl.addEventListener("touchstart", (e) => {
        const sq = e.target.closest(".sq");
        if(!sq) return;
        tryPlayerClick(sq.dataset.square);
      }, { passive:true });
    }

    function startNewGame(){
      if(!chess) return;
      chess.reset();
      selected = null;
      legalTargets.clear();
      thinking = false;
      capsYou = [];
      capsCpu = [];
      renderCaptured();
      renderBoard();
      updateGameStateText();
    }

    let chessInitDone = false;
    function initChessOnce(){
      if(chessInitDone) return;
      chessInitDone = true;

      if(typeof Chess !== "function"){
        setStatus("chess didnâ€™t load (check chess.min.js in your repo)");
        return;
      }

      chess = new Chess();
      wireBoardClicks();
      renderCaptured();
      renderBoard();
      updateGameStateText();
      newGameBtn.addEventListener("click", startNewGame);
      setMode(1);
    }
  </script>
</body>
</html>


